<!DOCTYPE html>
<html>
<head>
	<title>第一个示列</title>
	<meta charset="utf-8">
	<meta name='viewport' content="width=device-width,initial-scale=1.0,user-scalable=no">
	<style type="text/css">
		*{
			padding:0;
			margin:0;
			box-sizing:border-box;
		}

	</style>
	<script id='vertex-shader' type='x-shader/x-vertex'>
		attribute vec4 vPosition;
		attribute vec4 vColor;
		varying vec4 fColor;
		void main(){
			gl_Position=vPosition;
			fColor=vColor;
		}
	</script>
	<script id='fragment-shader' type="x-shader/x-fragment">
		precision mediump float;
		varying vec4 fColor;
		void main(){
			gl_FragColor=fColor;
		}
	</script>
	<script src="../Common/webgl-utils.js"></script>
	<script src="../Common/initShaders.js"></script>
	<script src="../Common/MV.js"></script>
</head>
<body>
	<canvas id='gl-canvas' width="512" height="512"></canvas>
	<select id="mymenu">
		<option value="0">Black</option>
		<option value="1">Red</option>
		<option value="2">Yellow</option>
		<option value="3">Green</option>
		<option value="4">Blue</option>
		<option value="5">Magenta</option>
		<option value="6">Cyan</option>
    </select>
    <button id="Button1">End Polygon</button>
	<script  type='text/javascript'>
			var canvas;
			var gl;
			var maxNumTriangles=200;
			var maxNumVertices=3*maxNumTriangles;
			var index=0;
			var cindex=0;

			var colors=[
				vec4(0.0,0.0,0.0,1.0),
				vec4(1.0,0.0,0.0,1.0),
				vec4(1.0,1.0,0.0,1.0),
				vec4(0.0,1.0,0.0,1.0),
				vec4(0.0,0.0,1.0,1.0),
				vec4(1.0,0.0,1.0,1.0),
				vec4(0.0,1.0,1.0,1.0)
			];

            var t; 
            var numPolygons=0;
            var numIndices=[];
            numIndices[0]=0;
            var start=[0];
			window.onload=function init(){
				canvas=document.getElementById("gl-canvas");
                gl=WebGLUtils.setupWebGL(canvas);
                if(!gl){
                    alert("Webgl isn't available");
                }
				gl.viewport(0,0,canvas.width,canvas.height);
				gl.clearColor(0.8,0.8,0.8,1.0);
				gl.clear(gl.COLOR_BUFFER_BIT);
				var program=initShaders(gl,"vertex-shader","fragment-shader");
                gl.useProgram(program);
                
                var m=document.getElementById("mymenu");
				m.addEventListener("click",function(){
					cindex=m.selectedIndex;
                });
                
                var a=document.getElementById("Button1");
                a.addEventListener("click",function(){
                    //当点击button绘制多边形的时候，多边形的个数加1
                    //多边形的边数先转变为0，然后之后的canvas里的
                    //mousedown事件里面每点击一次增加一条边
                    //start[numPolygons]=index的意思是从index开始画新的多边形
                    numPolygons++;//多边形的个数加1
                    numIndices[numPolygons]=0;
                    start[numPolygons]=index;
                    render();
                });

				canvas.addEventListener("mousedown",function(event){
                    t=vec2(2*event.clientX/canvas.width-1,2*(canvas.height-event.clientY)/canvas.height-1);
                    //点的坐标
                    gl.bindBuffer(gl.ARRAY_BUFFER,bufferId);
                    gl.bufferSubData(gl.ARRAY_BUFFER,8*index,flatten(t));
                    t=vec4(colors[cindex]);//颜色
                    gl.bindBuffer(gl.ARRAY_BUFFER,cBufferId);//切换绑定
                    gl.bufferSubData(gl.ARRAY_BUFFER,16*index,flatten(t));
                    numIndices[numPolygons]++;
                    index++;
                });

                var bufferId=gl.createBuffer();
                gl.bindBuffer(gl.ARRAY_BUFFER,bufferId);
                gl.bufferData(gl.ARRAY_BUFFER,8*maxNumVertices,gl.STATIC_DRAW);
                var vPos=gl.getAttribLocation(program,"vPosition");
                gl.vertexAttribPointer(vPos,2,gl.FLOAT,false,0,0);
                gl.enableVertexAttribArray(vPos);
                //从上一行代码可知，可以先开启，然后
                //又由下面的代码知道，当调用gl.bindBuffer之前其顶点所对应的变量都绑定在上面的buffer上

                var cBufferId=gl.createBuffer();
                gl.bindBuffer(gl.ARRAY_BUFFER,cBufferId);
                gl.bufferData(gl.ARRAY_BUFFER,16*maxNumVertices,gl.STATIC_DRAW);
                var vColor=gl.getAttribLocation(program,"vColor");
                gl.vertexAttribPointer(vColor,4,gl.FLOAT,false,0,0);
                gl.enableVertexAttribArray(vColor);
			}

			function render(){
				gl.clear(gl.COLOR_BUFFER_BIT);
				for(var i=0;i<numPolygons;i++){
                    gl.drawArrays(gl.TRIANGLE_FAN,start[i],numIndices[i]);
                }
			}
	</script>
	
</body>
</html>
