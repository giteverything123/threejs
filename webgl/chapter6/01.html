<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>用正四面体逼近球体</title>
    <style>
        *{
            margin:0;padding:0;box-sizing: border-box;
        }
    </style>
</head>
<body>
    <canvas id="webglcanvas"></canvas>
    <script id="vertex-shader" type="x-shader/x-vertex">
        attribute vec4 vposition;
        uniform mat4 modelMatrix;
        uniform mat4 projectMatrix;
        void main(){
            gl_Position=projectMatrix*modelMatrix*vposition;
        }
    </script>
    <script id="fragment-shader" type="x-shader/x-fragment">
        precision mediump float;
        void main(){
            gl_FragColor=vec4(1.0,0.0,0.0,1.0);
        }
    </script>
    <script src="../Common/webgl-utils.js"></script>
	<script src="../Common/initShaders.js"></script>
    <script src="../Common/MV.js"></script>
    <script>
        window.onload=()=>{
            let canvas=document.getElementById('webglcanvas');
            let WIDTH=document.body.clientWidth;
            canvas.width=WIDTH;
            canvas.height=WIDTH;
            let gl=WebGLUtils.setupWebGL(canvas);
            if(!gl){
                alert('您的浏览器还不支持webgl');
            }
            let program=initShaders(gl,'vertex-shader','fragment-shader');
            gl.useProgram(program);
            gl.viewport(0,0,canvas.width,canvas.height);
            gl.clearColor(1.0,1.0,1.0,1.0);
            gl.enable(gl.DEPTH_TEST);
            let points=[];
            let vertexArray=[
                vec4(0.0,0.942809,0.333333,1.0),
                vec4(-0.816497,-0.471405,0.333333,1.0),
                vec4(0.816497,-0.471405,0.333333,1.0),
                vec4(0.0,0.0,-1.0,1.0)
            ];
            let triangle=(a,b,c)=>{
                points.push(a,b,c);
            }
            let divideTriangle=(a,b,c,count)=>{
                if(count==0){
                    triangle(a,b,c);
                }else{
                    count--;
                    let ab=normalize(mix(a,b,0.5),true);
                    let ac=normalize(mix(a,c,0.5),true);
                    let bc=normalize(mix(b,c,0.5),true);
                    divideTriangle(a,ab,ac,count);
                    divideTriangle(ab,b,bc,count);
                    divideTriangle(ab,bc,ac,count);
                    divideTriangle(ac,bc,c,count);
                }
            }
            let sphereTriangle=(a,b,c,d,n)=>{
                divideTriangle(a,b,c,n);
                divideTriangle(a,c,d,n);
                divideTriangle(a,d,b,n);
                divideTriangle(c,b,d,n);
            }

            sphereTriangle(vertexArray[0],vertexArray[1],vertexArray[2],vertexArray[3],4);

            let eye=[0,2,1];
            let at=[0,0,0];
            let up=[0,1,0];

            let modelMatrix=lookAt(eye,at,up);

            let projectMatrix=ortho(-4,4,-4,4,-14,14);
            let modelMatrixLoc=gl.getUniformLocation(program,'modelMatrix');
            let projectMatrixLoc=gl.getUniformLocation(program,'projectMatrix');
            gl.uniformMatrix4fv(modelMatrixLoc,false,flatten(modelMatrix));
            gl.uniformMatrix4fv(projectMatrixLoc,false,flatten(projectMatrix));

            //创建缓存
            let buffer=gl.createBuffer();
            gl.bindBuffer(gl.ARRAY_BUFFER,buffer);
            gl.bufferData(gl.ARRAY_BUFFER,flatten(points),gl.STATIC_DRAW);
            let vposition=gl.getAttribLocation(program,'vposition');
            gl.vertexAttribPointer(vposition,4,gl.FLOAT,false,0,0);
            //上面一个函数参数的意思是
            //1.指定待分配attribute变量的存储位置
            //2.指定缓冲区中每个顶点的分量个数。
            //3.用什么类型的数据指定数据格式
            //4.传入false或true，表明是否将非浮点类型的数据归一化到[0,1]或[-1,1]之间。
            //5.指定相邻两个顶点间的字节数，默认为0
            //6.指定缓冲区对象中的偏移量，即attribute变量从缓冲区中何处开始存储。
            gl.enableVertexAttribArray(vposition);//激活
            gl.clear(gl.COLOR_BUFFER_BIT|gl.DEPTH_BUFFER_BIT);
            let len=points.length;
            for(let i=0;i<len;i+=3){
            	 gl.drawArrays(gl.LINE_STRIP,i,3);
            	 //从第i个点开始画,每次占3个点
            }

           
        }
    </script>
</body>
</html>